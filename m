Return-Path: <linux-kselftest-owner@vger.kernel.org>
X-Original-To: lists+linux-kselftest@lfdr.de
Delivered-To: lists+linux-kselftest@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 98F8976BDFD
	for <lists+linux-kselftest@lfdr.de>; Tue,  1 Aug 2023 21:42:45 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230043AbjHATmo (ORCPT <rfc822;lists+linux-kselftest@lfdr.de>);
        Tue, 1 Aug 2023 15:42:44 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:34262 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229841AbjHATmo (ORCPT
        <rfc822;linux-kselftest@vger.kernel.org>);
        Tue, 1 Aug 2023 15:42:44 -0400
Received: from bg4.exmail.qq.com (bg4.exmail.qq.com [43.154.54.12])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 5A669B4;
        Tue,  1 Aug 2023 12:42:42 -0700 (PDT)
X-QQ-mid: bizesmtp90t1690918952tllk1j5k
Received: from linux-lab-host.localdomain ( [116.30.131.233])
        by bizesmtp.qq.com (ESMTP) with 
        id ; Wed, 02 Aug 2023 03:42:31 +0800 (CST)
X-QQ-SSF: 01200000000000E0X000000A0000000
X-QQ-FEAT: ZTnzshg2nJY+dbg7dnU05oGs2oZJoFlj5DwKG4YmNlZjegD8qfswfCMygHPoE
        L10ipiSo21DO+0w3EvFmwlg0uJuV4b7xGHEzGgCpBvgE+5PfkniSob14/D3lbBZrcVUPDK7
        6AIyA9GE/1RUDjjkrJp3ZrlAkquUd/B0Uida7DV8vwoFLVf7NGwobAca8DpHJIJYUmYH3RE
        bLyuVu9jN3a16t89QTWcrwGzAmZS5jyXXy1ITQRWTy4HCNdr9gtP7HYZBE4HVobUBEuzKuM
        zC/pSp69bdqF9i8x+o/QyR+jA3HutSxsS5ISBLW/Jj9lYTw0gb42U9yq+oTgZTMYugxvU1h
        D++AQN6bc91ufgdmqekKlk8f30RDGBtrt//aIJZCHh8ifQJDPtPYb3OqUoVBTj2xIyH3Z9V
X-QQ-GoodBg: 0
X-BIZMAIL-ID: 17612294270200470935
From:   Zhangjin Wu <falcon@tinylab.org>
To:     thomas@t-8ch.de
Cc:     falcon@tinylab.org, arnd@arndb.de, linux-kernel@vger.kernel.org,
        linux-kselftest@vger.kernel.org, w@1wt.eu,
        =?UTF-8?q?Thomas=20Wei=C3=9Fschuh?= <linux@weissschuh.net>
Subject: [PATCH v4 06/12] selftests/nolibc: add nolibc-test-config target
Date:   Wed,  2 Aug 2023 03:42:31 +0800
Message-Id: <c21c1c119d8398aaeef2020441e24a732ecc559b.1690916314.git.falcon@tinylab.org>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <cover.1690916314.git.falcon@tinylab.org>
References: <cover.1690916314.git.falcon@tinylab.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
X-QQ-SENDSIZE: 520
Feedback-ID: bizesmtp:tinylab.org:qybglogicsvrgz:qybglogicsvrgz5a-1
X-Spam-Status: No, score=-0.6 required=5.0 tests=BAYES_00,
        RCVD_IN_DNSWL_BLOCKED,RCVD_IN_MSPIKE_H2,RCVD_IN_VALIDITY_RPBL,
        SPF_HELO_NONE,SPF_PASS,T_SCC_BODY_TEXT_LINE autolearn=no
        autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kselftest.vger.kernel.org>
X-Mailing-List: linux-kselftest@vger.kernel.org

The default DEFCONFIG_<XARCH> of some architectures may not just work
for nolibc test, some require extra kernel config options to enable
features like console for print.

To make nolibc-test happy, a new nolibc-test-config target is added with
a new NOLIBC_TEST_CONFIG macro. The macro allows store extra common
options via nolibc-test-common.config and the ones by architecture (or
variant) via nolibc-test-$(XARCH).config.

During the nolibc-test-config target, the above extra options will be
appended to .config generated by the old DEFCONFIG_<XARCH> target or by
another config target specified via the CONFIG variable (e.g.
tinyconfig). At last, the 'allnoconfig' target is called with the
.config as the base to let them take effect and let new missing symbols
as no.

The scripts/kconfig/merge_config.sh tool is used to merge the extra
config files listed in NOLIBC_TEST_CONFIG.

Suggested-by: Thomas Weißschuh <linux@weissschuh.net>
Link: https://lore.kernel.org/lkml/67eb70d4-c9ff-4afc-bac7-7f36cc2c81bc@t-8ch.de/
Link: https://lore.kernel.org/lkml/74f6a3b5-666c-41e9-a3d5-0ed5457f20f5@t-8ch.de/
Suggested-by: Suggested-by: Willy Tarreau <w@1wt.eu>
Link: https://lore.kernel.org/lkml/20230730061801.GA7690@1wt.eu/#t
Reviewed-by: Thomas Weißschuh <linux@weissschuh.net>
Signed-off-by: Zhangjin Wu <falcon@tinylab.org>
---
 tools/testing/selftests/nolibc/Makefile | 22 ++++++++++++++++++++--
 1 file changed, 20 insertions(+), 2 deletions(-)

diff --git a/tools/testing/selftests/nolibc/Makefile b/tools/testing/selftests/nolibc/Makefile
index 7902b86911a5..f01b258ef19b 100644
--- a/tools/testing/selftests/nolibc/Makefile
+++ b/tools/testing/selftests/nolibc/Makefile
@@ -63,6 +63,10 @@ DEFCONFIG_s390       = defconfig
 DEFCONFIG_loongarch  = defconfig
 DEFCONFIG            = $(DEFCONFIG_$(XARCH))
 
+# extra configs/ files appended to .config during the nolibc-test-config target
+# include common + architecture specific
+NOLIBC_TEST_CONFIG   = nolibc-test-common.config nolibc-test-$(XARCH).config
+
 # optional tests to run (default = all)
 TEST =
 
@@ -192,8 +196,22 @@ MAKE_KERNEL   = $(MAKE) -C $(srctree) ARCH=$(ARCH) CC=$(CC) CROSS_COMPILE=$(CROS
 KERNEL_CONFIG = $(objtree)/.config
 KERNEL_IMAGE  = $(objtree)/$(IMAGE)
 
-defconfig:
-	$(Q)$(MAKE_KERNEL) mrproper $(DEFCONFIG) prepare
+# kernel config for nolibc-test
+#
+# - delete the current configuration and all generated files via 'mrproper' target
+# - generate .config via '$(CONFIG)' or '$(DEFCONFIG_$(XARCH))' target
+# - merge extra config options from $(NOLIBC_TEST_CONFIG) files to .config
+# - use merged .config as base and fills in any missing symbols with '# CONFIG_* is not set' via 'allnoconfig' target
+# - prepare things we need to do before we recursively start building the kernel via 'prepare' target
+#
+nolibc-test-config:
+	$(Q)$(MAKE_KERNEL) mrproper
+	$(Q)$(MAKE_KERNEL) $(or $(CONFIG),$(DEFCONFIG))
+	$(Q)$(srctree)/scripts/kconfig/merge_config.sh -Q -O "$(objtree)" -m "$(KERNEL_CONFIG)" $(foreach c,$(NOLIBC_TEST_CONFIG),$(wildcard $(CURDIR)/configs/$c))
+	$(Q)$(MAKE_KERNEL) KCONFIG_ALLCONFIG=$(KERNEL_CONFIG) allnoconfig
+	$(Q)$(MAKE_KERNEL) prepare
+
+defconfig: nolibc-test-config
 
 kernel: initramfs
 	$(Q)$(MAKE_KERNEL) $(IMAGE_NAME) CONFIG_INITRAMFS_SOURCE=$(CURDIR)/initramfs
-- 
2.25.1

