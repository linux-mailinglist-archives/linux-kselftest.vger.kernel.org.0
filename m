Return-Path: <linux-kselftest-owner@vger.kernel.org>
X-Original-To: lists+linux-kselftest@lfdr.de
Delivered-To: lists+linux-kselftest@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id CE6B320476B
	for <lists+linux-kselftest@lfdr.de>; Tue, 23 Jun 2020 04:47:09 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1731434AbgFWCrJ (ORCPT <rfc822;lists+linux-kselftest@lfdr.de>);
        Mon, 22 Jun 2020 22:47:09 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:58836 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1730456AbgFWCrI (ORCPT
        <rfc822;linux-kselftest@vger.kernel.org>);
        Mon, 22 Jun 2020 22:47:08 -0400
Received: from mail-wm1-x341.google.com (mail-wm1-x341.google.com [IPv6:2a00:1450:4864:20::341])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 47442C061573
        for <linux-kselftest@vger.kernel.org>; Mon, 22 Jun 2020 19:47:08 -0700 (PDT)
Received: by mail-wm1-x341.google.com with SMTP id f18so1607440wml.3
        for <linux-kselftest@vger.kernel.org>; Mon, 22 Jun 2020 19:47:08 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to
         :cc;
        bh=nO5X8az1iZdZpQgcucoRmbtaCiu8/dHvR/vuZisbGbg=;
        b=ZWus7F/wJ5uGQya+5s5/T0SJ/pHOu6ysTi808P3JHesr4MkDHHBWSCTZWZHhFAWQ0i
         kiHYEDyZOdgN48Iu28wFy9/I8HN9OM6RVX8iQqkDdzJtBB3iFmeipxarIHkTfvpaY3UM
         C6NViwBAby8Ca5tt4udkIHQOtMSDHmwOzLD/Fqt123GRK+QyK5cmcbZ6zV8n/+jiTJDv
         13D0YgnXySUirtY5wstCyg58sFZRXMVEhP+zam4kEMdP7N0gS35N3Ogg/VkF+lXGwX8N
         zAD5YuVZSsrKDoZHsEX6Ai2+60GP6zXJl+tT5Obi3yeL9N4d7jTcg3QILNc4Z7ZAJcDf
         OHgA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc;
        bh=nO5X8az1iZdZpQgcucoRmbtaCiu8/dHvR/vuZisbGbg=;
        b=FThUsC2/2PNffXzRyK14TZSa7aLQCoX1WYF2tikV+SGnZK8rn7J0ndbjl6KJc7chzG
         2QC9E00H9axD7ebt1zKP/q7zcmlK8VE9ChmC77KcIAc8dUrzxYNFfo1NSeGpPFQ5XIWg
         JWfOQxEYl18mWN4QCMn9NnhtgvOaOJ/fynu7iVAKjacHteskpSzlrXcbmenyeYXBOoWw
         MI5pWWoR8iLnHyUvbsfGRk63dkxA1H/QxdrRvEz/zqk84IUhpMr4QofiOdTunjqQDxER
         oaB5ts2ljXQYDhGlYaRREEIRwFMATEFip81xQigGHPsAqGrYmrcsBhEK845+Bw5n7x72
         6Whg==
X-Gm-Message-State: AOAM532LDgwTnCrcfbs/tQfsIcfkx51XT6E8XHxa6zB8zzeUve7Kylvs
        DDPE/RlDDZTgRKMV8+3qXWYJv5vEoMc9ndDgMTfCMA==
X-Google-Smtp-Source: ABdhPJwVhwBuznzaEXZC0Z8D79xNdvpGAAjV8U45ICfWzRKRdyWpqj9d6UN8PJvPV5l6xbkf9WzwPIIGOte4iLoo5wQ=
X-Received: by 2002:a1c:750e:: with SMTP id o14mr21195505wmc.86.1592880426707;
 Mon, 22 Jun 2020 19:47:06 -0700 (PDT)
MIME-Version: 1.0
References: <d38bf9f9-8a39-87a6-8ce7-d37e4a641675@gmail.com>
In-Reply-To: <d38bf9f9-8a39-87a6-8ce7-d37e4a641675@gmail.com>
From:   David Gow <davidgow@google.com>
Date:   Tue, 23 Jun 2020 10:46:54 +0800
Message-ID: <CABVgOSkwZUAEjxrqO46kqj=uY5HDzr-E_LR9i04yXEKqjp91Og@mail.gmail.com>
Subject: Re: RFC: KTAP documentation - expected messages
To:     Frank Rowand <frowand.list@gmail.com>
Cc:     "Bird, Tim" <Tim.Bird@sony.com>,
        "shuah@kernel.org" <shuah@kernel.org>,
        "linux-kselftest@vger.kernel.org" <linux-kselftest@vger.kernel.org>,
        Brendan Higgins <brendanhiggins@google.com>,
        Kees Cook <keescook@chromium.org>,
        Paolo Bonzini <pbonzini@redhat.com>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>
Content-Type: text/plain; charset="UTF-8"
Sender: linux-kselftest-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kselftest.vger.kernel.org>
X-Mailing-List: linux-kselftest@vger.kernel.org

On Mon, Jun 22, 2020 at 6:45 AM Frank Rowand <frowand.list@gmail.com> wrote:
>
> Tim Bird started a thread [1] proposing that he document the selftest result
> format used by Linux kernel tests.
>
> [1] https://lore.kernel.org/r/CY4PR13MB1175B804E31E502221BC8163FD830@CY4PR13MB1175.namprd13.prod.outlook.com
>
> The issue of messages generated by the kernel being tested (that are not
> messages directly created by the tests, but are instead triggered as a
> side effect of the test) came up.  In this thread, I will call these
> messages "expected messages".  Instead of sidetracking that thread with
> a proposal to handle expected messages, I am starting this new thread.

Thanks for doing this: I think there are quite a few tests which could
benefit from something like this.

I think there were actually two separate questions: what do we do with
unexpected messages (most of which I expect are useless, but some of
which may end up being related to an unexpected test failure), and how
to have tests "expect" a particular message to appear. I'll stick to
talking about the latter for this thread, but even there there's two
possible interpretations of "expected messages" we probably want to
explicitly distinguish between: a message which must be present for
the test to pass (which I think best fits the "expected message"
name), and a message which the test is likely to produce, but which
shouldn't alter the result (an "ignored message"). I don't see much
use for the latter at present, but if we wanted to do more things with
messages and had some otherwise very verbose tests, it could
potentially be useful.

The other thing I'd note here is that this proposal seems to be doing
all of the actual message filtering in userspace, which makes a lot of
sense for kselftest tests, but does mean that the kernel can't know if
the test has passed or failed. There's definitely a tradeoff between
trying to put too much needless string parsing in the kernel and
having to have a userland tool determine the test results. The
proposed KCSAN test suite[1] is using tracepoints to do this in the
kernel. It's not the cleanest thing, but there's no reason KUnit or
similar couldn't implement a nicer API around it.

[1]: https://lkml.org/lkml/2020/6/22/1506

> I implemented an API for expected messages that are triggered by tests
> in the Devicetree unittest code, with the expectation that the specific
> details may change when the Devicetree unittest code adapts the KUnit
> API.  It seems appropriate to incorporate the concept of expected
> messages in Tim's documentation instead of waiting to address the
> subject when the Devicetree unittest code adapts the KUnit API, since
> Tim's document may become the kernel selftest standard.

Is having a nice way to handle expected messages the only thing
holding up porting this to KUnit?

> Instead of creating a very long email containing multiple objects,
> I will reply to this email with a separate reply for each of:
>
>   The "expected messages" API implemention and use can be from
>   drivers/of/unittest.c in the mainline kernel.
>
>   of_unittest_expect - A proof of concept perl program to filter console
>                        output containing expected messages output
>
>                        of_unittest_expect is also available by cloning
>                        https://github.com/frowand/dt_tools.git
>
>   An example raw console output with timestamps and expect messages.
>
>   An example of console output processed by filter program
>   of_unittest_expect to be more human readable.  The expected
>   messages are not removed, but are flagged.
>
>   An example of console output processed by filter program
>   of_unittest_expect to be more human readable.  The expected
>   messages are removed instead of being flagged.

Cheers,
-- David
